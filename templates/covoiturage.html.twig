{% extends 'base.html.twig' %}

{% block title %}Rechercher un covoiturage - Ecoride{% endblock %}

{% block bigtitle %}
    <form id="search-form" action="{{ path('carpool_show') }}" method="GET" class="w-100">
        {% include 'bigtitle.html.twig' %}
    </form>
{% endblock %}

{% block body %}
<div class="container-fluid">
    <div class="row p-4" id="search-results-area">

        {# CORRECTION : On vérifie si une recherche a été effectuée #}
        {% if search_depart is defined and search_depart is not null %}

            <div class="container mt-4 mb-2 d-flex justify-content-between align-items-center">
                <h5 id="results-title" class="mb-0">Résultats pour votre recherche</h5>
                {# Le bouton Filtres ne s'affiche que s'il y a des résultats à filtrer #}
                {% if covoiturages is not empty %}
                    <button class="btn btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#filter-box">
                        <i class="bi bi-funnel-fill me-2"></i>Filtres
                    </button>
                {% endif %}
            </div>

            {# CORRECTION : La classe 'show' est retirée pour que les filtres soient masqués par défaut #}
            {% if covoiturages is not empty %}
                <div class="collapse" id="filter-box">
                    <div class="container mb-4">
                        <div class="card shadow-sm p-4">
                            <div class="row align-items-center gy-3">
                                <div class="col-lg-9">
                                    <div class="row g-4">
                                        <div class="col-md-6 col-lg-3 text-center">
                                            <label for="price-range" class="form-label fw-bold d-block mb-2"><i class="bi bi-coin me-2 text-primary fs-5"></i>Prix max.</label>
                                            <div class="d-flex align-items-center justify-content-center">
                                                <input type="range" class="form-range w-50" min="0" max="50" step="1" id="price-range" value="50">
                                                <span id="price-output" class="badge bg-primary ms-3" style="width: 50px;">50</span>
                                            </div>
                                        </div>
                                        <div class="col-md-6 col-lg-3 text-center">
                                            <label for="rating-range" class="form-label fw-bold d-block mb-2"><i class="bi bi-star-half me-2 text-success fs-5"></i>Note min.</label>
                                            <div class="d-flex align-items-center justify-content-center">
                                                <input type="range" class="form-range w-50" min="0" max="5" step="1" id="rating-range" value="0">
                                                <span id="rating-output" class="badge bg-success ms-3" style="width: 80px;">Toutes</span>
                                            </div>
                                        </div>
                                        <div class="col-md-6 col-lg-3 text-center">
                                            <label for="duration-range" class="form-label fw-bold d-block mb-2"><i class="bi bi-clock-history me-2 text-info fs-5"></i>Durée max.</label>
                                            <div class="d-flex align-items-center justify-content-center">
                                                <input type="range" class="form-range w-50" min="0" max="1440" step="30" id="duration-range" value="1440">
                                                <span id="duration-output" class="badge bg-info ms-3" style="width: 80px;">Illimitée</span>
                                            </div>
                                        </div>
                                        <div class="col-md-6 col-lg-3 text-center">
                                            <label class="form-check-label fw-bold mb-0" for="eco-filter"><i class="bi bi-leaf-fill fs-5 text-primary me-2"></i>Écologique</label>
                                            <div class="form-check form-switch d-flex justify-content-center mt-1">
                                                <input class="form-check-input" type="checkbox" id="eco-filter" style="height: 1.5rem; width: 3rem;">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-3 text-center mt-3 mt-lg-0">
                                    <button id="apply-filters-btn" class="btn btn-primary">Appliquer</button>
                                    <button id="reset-filters-btn" class="btn btn-dark ms-2">Réinitialiser</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}

            <div class="row mt-3" id="trip-results-list">
                {% if covoiturages is not empty %}
                    {% for trip in covoiturages %}
                        {# Calcul de la durée en minutes et ajout de l'attribut data-duration #}
                        {% set start_datetime = date(trip.dateDepart|date('Y-m-d') ~ ' ' ~ trip.heureDepart) %}
                        {% set end_datetime = date(trip.dateArrivee|date('Y-m-d') ~ ' ' ~ trip.heureArrivee) %}
                        {% set duration_seconds = end_datetime|date('U') - start_datetime|date('U') %}
                        {% set duration_minutes = (duration_seconds / 60)|round %}

                        <div class="col-12 col-md-6 col-lg-4 col-xl-3 mb-4 trip-card" 
                             data-price="{{ trip.prix }}" 
                             data-rating="{{ trip.chauffeur.noteMoyenne|default(0) }}" 
                             data-eco="{{ (trip.voiture and (trip.voiture.energie|lower == 'electric' or trip.voiture.energie|lower == 'hybrid')) ? 'true' : 'false' }}"
                             data-duration="{{ duration_minutes }}">
                            <div class="card h-100 shadow-sm border-light card-trip">
                                <div class="card-header bg-primary text-white p-3 d-flex align-items-center gap-3">
                                    <img src="{{ trip.chauffeur.photo ? asset('uploads/photos/' ~ trip.chauffeur.photo) : 'https://i.pravatar.cc/60?u=' ~ trip.chauffeur.id }}" class="rounded-circle border border-2 border-light" width="60" height="60" alt="photo de {{ trip.chauffeur.pseudo }}">
                                    <div>
                                        <h6 class="card-title mb-0 fw-bold">{{ trip.chauffeur.pseudo }}</h6>
                                        <span class="text-warning small"><i class="bi bi-star-fill"></i> {{ trip.chauffeur.noteMoyenne|number_format(1, ',')|default('N/A') }}</span>
                                    </div>
                                </div>
                                <div class="card-body p-3 d-flex flex-column">
                                    <div class="text-center mb-2">
                                        <h6 class="text-dark fw-bold mb-0">{{ trip.dateDepart|format_datetime('full', 'none', locale='fr')|capitalize }}</h6>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <div class="text-center">
                                            <div class="fw-bold fs-5">{{ trip.heureDepart }}</div>
                                            <div class="text-muted small">{{ trip.villeDepart }}</div>
                                        </div>
                                        <div class="text-primary px-2">
                                            <i class="bi bi-arrow-right-circle" style="font-size: 1.5rem;"></i>
                                        </div>
                                        <div class="text-center">
                                            <div class="fw-bold fs-5">{{ trip.heureArrivee }}</div>
                                            <div class="text-muted small">{{ trip.villeArrivee }}</div>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1"></div>
                                    <hr class="my-2">
                                    <div class="d-flex justify-content-around text-center small">
                                        <div>
                                            <i class="bi bi-cash-coin text-success fs-5 d-block"></i>
                                            <div class="fw-bold">{{ trip.prix }} crédits</div>
                                        </div>
                                        <div>
                                            <i class="bi bi-people-fill text-info fs-5 d-block"></i>
                                            <div class="fw-bold">{{ trip.placesDisponibles }} places</div>
                                        </div>
                                        <div>
                                            <i class="bi bi-clock-history text-secondary fs-5 d-block"></i>
                                            <div class="fw-bold">
                                                {% set hours = (duration_minutes / 60)|round(0, 'floor') %}
                                                {% set minutes = duration_minutes % 60 %}
                                                {% if duration_minutes < 1 %}
                                                    -
                                                {% else %}
                                                    {{ hours > 0 ? hours ~ 'h' : '' }}{{ minutes > 0 ? ' ' ~ minutes ~ 'min' : '' }}
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div>
                                            {% set isEco = trip.voiture and (trip.voiture.energie|lower == 'electric' or trip.voiture.energie|lower == 'hybrid') %}
                                            <i class="bi {{ isEco ? 'bi-leaf-fill text-primary' : 'bi-fuel-pump-fill text-secondary' }} fs-5 d-block"></i>
                                            <div class="fw-bold">{{ isEco ? 'Éco' : 'Thermique' }}</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-footer bg-white border-0 p-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="text-muted small">
                                            <i class="bi bi-car-front-fill"></i>
                                            {{ trip.voiture.marque.libelle }} {{ trip.voiture.modele }}
                                        </span>
                                        <a href="{{ path('carpool_detail', {'id': trip.id}) }}" class="btn btn-primary fw-bold">Détails</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    {# Message si aucun résultat n'est trouvé #}
                    <div class="alert alert-warning text-center mt-4" role="alert">
                        <h5 class="mb-3">Aucun covoiturage ne correspond à votre recherche.</h5>
                        {# Suggestion si un prochain trajet existe #}
                        {% if nextAvailable %}
                            <p>Le prochain départ disponible pour ce trajet est le <strong>{{ nextAvailable.dateDepart|format_datetime('full', 'none', locale='fr') }} à {{ nextAvailable.heureDepart }}</strong>.</p>
                            <a href="{{ path('carpool_show', { 'depart': search_depart, 'arrivee': search_arrivee, 'date': nextAvailable.dateDepart|date("Y-m-d") }) }}" class="btn btn-outline-primary mt-2">
                                Voir les trajets pour cette date
                            </a>
                        {% else %}
                            <p>Essayez de modifier votre recherche ou d'élargir vos dates.</p>
                        {% endif %}
                    </div>
                {% endif %}
            </div>

        {% else %}
            {# Message par défaut si aucune recherche n'a été faite #}
            <div id="initial-message" class="alert alert-info text-center mt-4" role="alert">
                <h4 class="alert-heading"><i class="bi bi-search"></i> Prêt à partir ?</h4>
                <p>Utilisez la barre de recherche ci-dessus pour trouver votre prochain covoiturage !</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset('js/search_carpool.js') }}" defer></script>
    
    {% if app.user %}
        <script src="{{ asset('js/notifications.js') }}" defer></script>
    {% endif %}

{% endblock %}